<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ТТК Бара</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght400;700&display=swap" rel="stylesheet">
    <style>
        /* =======================================
           СТИЛИ CSS
           ======================================= */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff; /* Белый фон */
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #f8f8f8;
            color: #333;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        /* Стили для поля поиска */
        #search-container {
            padding: 10px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        #search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
        }

        #search-input:focus {
            outline: none;
            border-color: #2980b9;
        }

        #drinks-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            gap: 20px;
        }

        /* Стиль карточки напитка - служит прозрачной кнопкой */
        .drink-card {
            /* Полупрозрачный фон, близкий к требованиям */
            background: rgba(255, 255, 255, 0.7); 
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            width: 100%;
            max-width: 280px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            overflow: hidden;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 600px) {
            .drink-card {
                max-width: 90%; 
            }
        }

        .drink-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9); /* Чуть менее прозрачный при наведении */
        }

        .drink-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .drink-card h2 {
            font-size: 1.2em;
            margin: 5px 0 5px 0;
            color: #333;
        }
        
        .drink-card p {
            font-size: 0.9em;
            color: #555;
            margin: 0;
        }

        /* Модальное окно */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* Центрирование сверху */
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation-name: animatetop;
            animation-duration: 0.4s
        }
        
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 5%; opacity: 1}
        }

        /* Прозрачная кнопка закрытия модального окна */
        .close-button {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            background: transparent; 
            border: none;
            padding: 0 10px;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }

        #modal-body h2 {
            text-align: center;
            color: #2980b9;
            margin-top: 0;
            margin-bottom: 20px;
        }

        #modal-body img {
            display: block;
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin: 10px auto 20px auto;
            border-radius: 8px;
        }

        /* Новый стиль для блоков состава/рецепта */
        .detail-block {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f4f7f9; /* Светло-серый фон */
            border-left: 4px solid #3498db; /* Яркая синяя полоса */
            border-radius: 6px;
        }
        
        .detail-block strong {
            display: block;
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 8px;
            border-bottom: 1px solid #e1e1e1;
            padding-bottom: 5px;
        }
        
        .detail-block pre {
            /* Используем pre-wrap для сохранения переносов строк из JS-форматирования */
            white-space: pre-wrap;
            word-break: break-word;
            font-family: inherit; /* Используем тот же шрифт, что и в body */
            margin: 0;
            padding: 0;
            color: #444;
        }

        #loading-message, #error-message, #no-results {
            width: 100%;
            text-align: center;
            font-size: 1.2em;
            padding: 50px;
            color: #999;
        }
    </style>
</head>
<body>
    <header>
        <h1>Технологические Карты Бара</h1>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Введите название, ингредиент или слово из рецепта..." aria-label="Поиск напитков">
        </div>
    </header>

    <main id="drinks-container">
        <!-- Сообщение о загрузке или ошибке -->
        <p id="loading-message">Загрузка данных...</p>
    </main>

    <!-- Модальное окно для отображения деталей -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" role="button" aria-label="Закрыть">&times;</span>
            <div id="modal-body">
                <!-- Детали напитка будут вставлены сюда -->
            </div>
        </div>
    </div>

    <script>
        // =======================================
        // ЛОГИКА JAVASCRIPT
        // =======================================

        // URL для загрузки CSV-данных
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0ukbh5K5GdykFFCDj-H0xUODUAneKWmbeJFfe4tLTCMEWKJgCkefhrCOtsKDB_QRRYySAvI1xOTh3/pub?gid=1617440067&single=true&output=csv';

        // Элементы DOM
        const drinksContainer = document.getElementById('drinks-container');
        const loadingMessage = document.getElementById('loading-message');
        const searchInput = document.getElementById('search-input');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.close-button');

        // Глобальное хранилище данных
        let allDrinksData = [];

        /**
         * Вспомогательная функция для очистки значения CSV: 
         * удаление лишних пробелов, обратных слешей и окружающих кавычек.
         * @param {string} value - Необработанное значение из CSV.
         * @returns {string} Очищенное значение.
         */
        function cleanCSVValue(value) {
            let cleaned = (value || '').trim();
            // 1. Замена CSV-специфичных переносов строк (\r\n) и экранированных переносов (\n)
            cleaned = cleaned.replace(/\r\n/g, '\n').replace(/\\n/g, '\n');
            
            // 2. Удаление внешних кавычек, если они есть
            if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                cleaned = cleaned.substring(1, cleaned.length - 1);
            }
            
            // 3. Замена внутренних двойных кавычек (экранирование в CSV) на одиночные
            cleaned = cleaned.replace(/""/g, '"');
            
            return cleaned.trim();
        }
        
        /**
         * Форматирует строку с нумерованным списком (1....2....)
         * в читаемый список с переносами строк.
         * @param {string} text - Исходный текст списка.
         * @returns {string} Отформатированный текст.
         */
        function formatNumberedList(text) {
            if (!text) return 'Не указан';
            // 1. Очистить текст от лишних пробелов в начале/конце.
            text = text.trim();
            
            // 2. Найти все шаблоны нумерации (например, "1.", "2.") и заменить их
            // на символ переноса строки + сам шаблон.
            // (\s*) - ловит возможные пробелы перед номером
            // (\d+\.\s*) - ищет одну или более цифр, точку, и 0 или более пробелов.
            let formattedText = text.replace(/(\s*)(\d+\.\s*)/g, '\n$2');
            
            // 3. Удаляем возможный лишний перенос строки, если он был добавлен в начале
            if (formattedText.startsWith('\n')) {
                formattedText = formattedText.substring(1);
            }

            return formattedText;
        }


        /**
         * Парсит CSV текст в массив объектов, предполагая, что данные
         * находятся в 5 отдельных столбцах.
         * @param {string} text - Содержимое CSV файла.
         * @returns {Array<Object>} Массив объектов напитков.
         */
        function parseCSV(text) {
            // Разделяем CSV на строки, фильтруя пустые.
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return []; // Пропускаем заголовок и пустые строки

            const data = [];
            
            // Начинаем со второй строки (данные)
            for (let i = 1; i < lines.length; i++) {
                // Используем регекс для разделения по запятой, которая НЕ находится внутри кавычек.
                // Это важно для ячеек, содержащих переносы строк (они оборачиваются в кавычки)
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                // Проверяем, что у нас есть хотя бы 5 столбцов (Название, Состав, Рецепт, Объём, Фото)
                if (values.length < 5) {
                    console.warn(`Пропущена строка ${i + 1} из-за недостаточного количества столбцов (${values.length} < 5). Содержимое строки: ${lines[i]}`);
                    continue; // Переходим к следующей строке CSV
                }
                
                const drink = {
                    // Используем cleanCSVValue для обработки кавычек и переносов строк
                    название: cleanCSVValue(values[0]),  // Столбец 1
                    состав: cleanCSVValue(values[1]),    // Столбец 2
                    рецепт: cleanCSVValue(values[2]),    // Столбец 3
                    объём: cleanCSVValue(values[3]),     // Столбец 4
                    фото: cleanCSVValue(values[4])       // Столбец 5
                };

                // Добавляем напиток только если есть название
                if (drink.название) {
                    data.push(drink);
                }
            }
            return data;
        }

        /**
         * Создает HTML-карточку для напитка.
         * @param {Object} drink - Объект напитка.
         * @returns {HTMLElement} HTML-элемент карточки.
         */
        function createDrinkCard(drink) {
            const card = document.createElement('div');
            card.className = 'drink-card';
            
            // Замена на заглушку, если фото отсутствует или не является URL
            const imageUrl = drink.фото && drink.фото.startsWith('http') ? drink.фото : 'https://placehold.co/280x180/2980b9/ffffff?text=Нет+Фото';

            card.innerHTML = `
                <img 
                    src="${imageUrl}" 
                    alt="${drink.название}" 
                    onerror="this.onerror=null;this.src='https://placehold.co/280x180/7f8c8d/ffffff?text=Нет+Фото'"
                >
                <h2>${drink.название}</h2>
                <p>${drink.объём || 'Объём не указан'}</p>
            `;
            
            // Обработчик клика
            card.addEventListener('click', () => openModal(drink));

            return card;
        }
        
        /**
         * Рендерит карточки напитков на основе переданного массива данных.
         * @param {Array<Object>} drinks - Массив объектов напитков для отображения.
         */
        function renderDrinks(drinks) {
            drinksContainer.innerHTML = ''; // Очищаем контейнер

            if (drinks.length === 0) {
                const message = document.createElement('p');
                message.id = 'no-results';
                message.textContent = allDrinksData.length > 0 ? 'Ничего не найдено по вашему запросу.' : 'Данные о напитках не найдены.';
                drinksContainer.appendChild(message);
                return;
            }

            drinks.forEach(drink => {
                const card = createDrinkCard(drink);
                drinksContainer.appendChild(card);
            });
        }
        
        /**
         * Фильтрует напитки на основе ввода пользователя в поле поиска.
         * Теперь ищет по Названию, Составу и Рецепту.
         */
        function filterDrinks() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderDrinks(allDrinksData);
                return;
            }

            const filtered = allDrinksData.filter(drink => {
                // Все поля приводятся к нижнему регистру для нечувствительного к регистру поиска
                const nameMatch = drink.название.toLowerCase().includes(searchTerm);
                const compositionMatch = drink.состав.toLowerCase().includes(searchTerm);
                const recipeMatch = drink.рецепт.toLowerCase().includes(searchTerm);
                
                // Напиток соответствует, если поиск совпал хотя бы в одном из полей
                return nameMatch || compositionMatch || recipeMatch;
            });

            renderDrinks(filtered);
        }


        /**
         * Открывает модальное окно с деталями напитка.
         * @param {Object} drink - Объект напитка.
         */
        function openModal(drink) {
            const imageUrl = drink.фото && drink.фото.startsWith('http') ? drink.фото : 'https://placehold.co/700x300/2980b9/ffffff?text=Нет+Фото';
            
            // 1. Форматирование состава и рецепта для новой строки
            const formattedComposition = formatNumberedList(drink.состав);
            const formattedRecipe = formatNumberedList(drink.рецепт);

            // 2. Новая визуальная подача (Сначала Состав и Рецепт, затем Объём)
            modalBody.innerHTML = `
                <h2>${drink.название}</h2>
                <img 
                    src="${imageUrl}" 
                    alt="${drink.название}"
                    onerror="this.onerror=null;this.src='https://placehold.co/700x300/7f8c8d/ffffff?text=Нет+Фото'"
                >

                <div class="detail-block">
                    <strong>Состав:</strong>
                    <pre>${formattedComposition}</pre>
                </div>

                <div class="detail-block">
                    <strong>Рецепт:</strong>
                    <pre>${formattedRecipe}</pre>
                </div>

                <div class="detail-block" style="border-left-color: #27ae60;">
                    <strong>Объём:</strong>
                    <pre>${drink.объём || 'Не указан'}</pre>
                </div>
            `;
            modal.style.display = 'block';
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
        }

        /**
         * Основная функция инициализации: загрузка данных и рендеринг.
         */
        async function init() {
            loadingMessage.textContent = 'Загрузка данных...';
            try {
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    // Обработка ошибок (404/403/400), которые указывают на проблему с URL или доступом
                    let statusText = response.statusText || 'Неизвестная ошибка';
                    let errorMessage = `Ошибка загрузки: ${response.status} ${statusText}`;
                    
                    if (response.status === 404) {
                        errorMessage += `. Пожалуйста, проверьте, что ссылка (CSV_URL) скопирована верно и ваша Google Таблица опубликована для доступа по ссылке (Файл -> Открыть доступ -> Опубликовать в интернете -> CSV).`;
                    } else if (response.status === 403) {
                         errorMessage += `. Доступ запрещен. Убедитесь, что таблица опубликована для всех.`;
                    } else if (response.status === 400) {
                         errorMessage += `. Bad Request. Это означает, что сервер (Google Sheets) не смог обработать запрос. Возможно, таблица содержит несовместимый контент или нуждается в повторной публикации. Рекомендация: Попробуйте заново выполнить "Опубликовать в интернете".`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const csvText = await response.text();
                allDrinksData = parseCSV(csvText); // Сохраняем данные глобально
                
                loadingMessage.style.display = 'none';

                if (allDrinksData.length === 0) {
                    // Уведомление о том, что данные не были загружены
                    drinksContainer.innerHTML = `
                        <p id="no-results" style="padding: 20px; max-width: 500px; margin: 40px auto; background: #ffebeb; border: 1px solid #f4c7c7; border-radius: 8px;">
                            <strong>Не удалось загрузить данные.</strong><br>
                            Возможно, в таблице нет строк данных, кроме заголовка.
                        </p>
                    `;
                    console.log("Данные не загружены. Массив allDrinksData пуст.");
                } else {
                    renderDrinks(allDrinksData); // Рендерим все напитки
                    console.log(`Успешно загружено ${allDrinksData.length} напитков.`);
                }

            } catch (error) {
                console.error('Критическая ошибка при загрузке или обработке данных:', error);
                // Выводим более подробную и действенную ошибку для пользователя
                drinksContainer.innerHTML = `
                    <p id="error-message" style="padding: 20px; max-width: 500px; margin: 40px auto; background: #ffebeb; border: 1px solid #f4c7c7; border-radius: 8px;">
                        <strong>Критическая ошибка загрузки данных:</strong><br>
                        ${error.message}<br><br>
                        Для устранения ошибки:
                        <ol style="margin-left: 20px; padding-left: 0; text-align: left; list-style-type: disc;">
                            <li>Проверьте, что URL в начале скрипта (константа CSV_URL) полностью и верно скопирован.</li>
                            <li>Убедитесь, что Google Таблица **опубликована в интернете** в формате **CSV** (Файл -> Открыть доступ -> Опубликовать в интернете).</li>
                        </ol>
                    </p>
                `;
            }
        }

        // Обработчики событий
        searchInput.addEventListener('input', filterDrinks);
        closeButton.addEventListener('click', closeModal);

        // Закрытие модального окна по клику вне его (на затемненном фоне)
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        // Закрытие модального окна по кнопке ESC
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal.style.display === 'block') {
                closeModal();
            }
        });

        // Запуск приложения при загрузке страницы
        init();
    </script>
</body>
</html>



